# K8s Automata

This project contains Terraform and Ansible scripts to automatically deploy Kubernetes clusters on AWS and Proxmox platforms.

## Features

- ðŸš€ Automated Kubernetes cluster deployment
- â˜ï¸ Support for AWS EC2 instances
- ðŸ–¥ï¸ Support for Proxmox virtual machines
- ðŸ”§ Configurable cluster size and instance types
- ðŸ“¦ Automated inventory generation
- ðŸŒ CNI networking with Flannel
- ðŸ”’ Secure configuration with proper RBAC

## Prerequisites

### Required Tools
- [Terraform](https://www.terraform.io/downloads.html) >= 1.0
- [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) >= 2.9
- SSH key pair for accessing instances

### Platform-Specific Requirements

#### AWS
- AWS CLI configured with appropriate credentials
- IAM permissions for EC2, VPC, and related services

#### Proxmox
- Proxmox VE server with API access
- API token configured
- Ubuntu 22.04 cloud-init template prepared

## Quick Start

### 1. Clone and Setup

```bash
git clone https://github.com/AnataAria/k8s-automata.git
cd k8s-automata
chmod +x setup-k8s.sh
```

### 2. Configure for AWS

```bash
cp terraform/aws/terraform.tfvars.example terraform/aws/terraform.tfvars
nano terraform/aws/terraform.tfvars
```

Edit the following variables:
- `aws_region`: Your preferred AWS region
- `public_key`: Your SSH public key
- `cluster_name`: Name for your cluster
- Instance types and counts as needed

### 3. Configure for Proxmox

```bash
cp terraform/proxmox/terraform.tfvars.example terraform/proxmox/terraform.tfvars
nano terraform/proxmox/terraform.tfvars
```

Edit the following variables:
- `proxmox_api_url`: Your Proxmox server URL
- `proxmox_api_token_id` and `proxmox_api_token_secret`: API credentials
- `proxmox_node`: Target Proxmox node
- `template_name`: Your Ubuntu template name
- Network and IP configuration

### 4. Deploy Kubernetes

#### Deploy on AWS
```bash
./setup-k8s.sh aws plan
./setup-k8s.sh aws apply
```

#### Deploy on Proxmox
```bash
./setup-k8s.sh proxmox plan
./setup-k8s.sh proxmox apply
```

#### Deploy on Both Platforms
```bash
./setup-k8s.sh both apply
```

## Manual Operations

### Run Only Ansible (if infrastructure exists)
```bash
./setup-k8s.sh aws ansible
./setup-k8s.sh proxmox ansible
```

### Destroy Infrastructure
```bash
./setup-k8s.sh aws destroy
./setup-k8s.sh proxmox destroy
```

## Directory Structure

```
k8s-automata/
â”œâ”€â”€ setup-k8s.sh                 # Main deployment script
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ aws/
â”‚   â”‚   â”œâ”€â”€ main.tf              # AWS infrastructure
â”‚   â”‚   â”œâ”€â”€ variables.tf         # AWS variables
â”‚   â”‚   â”œâ”€â”€ outputs.tf           # AWS outputs
â”‚   â”‚   â”œâ”€â”€ inventory.tpl        # Ansible inventory template
â”‚   â”‚   â””â”€â”€ terraform.tfvars.example
â”‚   â””â”€â”€ proxmox/
â”‚       â”œâ”€â”€ main.tf              # Proxmox infrastructure
â”‚       â”œâ”€â”€ variables.tf         # Proxmox variables
â”‚       â”œâ”€â”€ outputs.tf           # Proxmox outputs
â”‚       â”œâ”€â”€ inventory.tpl        # Ansible inventory template
â”‚       â””â”€â”€ terraform.tfvars.example
â””â”€â”€ ansible/
    â”œâ”€â”€ ansible.cfg              # Ansible configuration
    â”œâ”€â”€ inventories/
    â”‚   â”œâ”€â”€ aws/
    â”‚   â”‚   â””â”€â”€ hosts.ini        # Generated by Terraform
    â”‚   â””â”€â”€ proxmox/
    â”‚       â””â”€â”€ hosts.ini        # Generated by Terraform
    â”œâ”€â”€ playbooks/
    â”‚   â”œâ”€â”€ site.yaml           # Main playbook
    â”‚   â”œâ”€â”€ init-masters.yaml   # Master-only setup
    â”‚   â””â”€â”€ join-workers.yaml   # Worker-only setup
    â””â”€â”€ roles/
        â”œâ”€â”€ common/             # Common system setup
        â”œâ”€â”€ docker/             # Container runtime
        â”œâ”€â”€ kubernetes/         # K8s packages
        â”œâ”€â”€ k8s-master/         # Master initialization
        â””â”€â”€ k8s-worker/         # Worker joining
```

## Configuration Details

### AWS Configuration

Key variables in `terraform/aws/terraform.tfvars`:

```hcl
aws_region = "us-west-2"
cluster_name = "my-k8s-cluster"
vpc_cidr = "10.0.0.0/16"
public_subnet_cidr = "10.0.1.0/24"

# Instance configuration
ami_id = "ami-0c02fb55956c7d316"  # Ubuntu 22.04 LTS
master_instance_type = "t3.medium"
worker_instance_type = "t3.medium"
master_count = 1
worker_count = 2

# SSH access
public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD..."
```

### Proxmox Configuration

Key variables in `terraform/proxmox/terraform.tfvars`:

```hcl
proxmox_api_url = "https://your-proxmox:8006/api2/json"
proxmox_api_token_id = "terraform@pve!terraform"
proxmox_api_token_secret = "your-secret"
proxmox_node = "pve"

# VM configuration
template_name = "ubuntu-22.04-template"
master_count = 1
worker_count = 2
master_cores = 2
master_memory = 4096

# Network
network_bridge = "vmbr0"
gateway = "192.168.1.1"
master_ip_base = "192.168.1"
```

## Accessing Your Cluster

After deployment, the Kubernetes config is available on the master node(s):

```bash
ssh ubuntu@<master-ip>

kubectl get nodes
kubectl get pods --all-namespaces

scp ubuntu@<master-ip>:~/.kube/config ~/.kube/config-cluster-name
```

## Customization

### Adding Custom Roles

Add new roles in `ansible/roles/` and include them in the playbooks.

### Modifying Network Configuration

- AWS: Edit VPC and subnet CIDR ranges in variables
- Proxmox: Adjust IP ranges and network bridge settings

### Scaling Clusters

Modify `master_count` and `worker_count` variables and re-run:

```bash
./setup-k8s.sh [platform] apply
```
